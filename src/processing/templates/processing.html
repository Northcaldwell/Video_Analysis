{% extends "base.html" %}

{% block title %}Processing – Case {{ project.case_number }}{% endblock %}

{% block content %}
  <h1>Processing Case {{ project.case_number }}</h1>
  <form id="plugin-form">
    <fieldset>
      <legend>Select Analyses</legend>
      {% for plugin in plugins %}
        <label>
          <input type="checkbox" name="plugins" value="{{ plugin }}">
          {{ plugin }}
        </label><br>
      {% endfor %}
    </fieldset>
    <button type="submit">Start Analysis</button>
    <button type="button" id="cancel-btn">Cancel</button>
  </form>

  <div id="progress">
    <div id="status">Waiting to start…</div>
    <progress id="bar" value="0" max="100"></progress>
  </div>

  <pre id="log-window" style="height:300px; overflow:auto; border:1px solid #ccc; padding:10px;"></pre>
{% endblock %}

{% block scripts %}
<script>
// Kick off analysis when form submits
document.getElementById('plugin-form').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  fetch('{{ url_for("processing.start_analysis", project_id=project.id) }}', {
    method: 'POST', body: data
  })
  .then(res => res.json())
  .then(json => {
    if (json.task_id) startStream(json.task_id);
  });
});

// Cancel button
document.getElementById('cancel-btn').addEventListener('click', () => {
  fetch('{{ url_for("processing.cancel_project", project_id=project.id) }}?task_id=' + currentTask, {
    method: 'DELETE'
  });
});

// SSE listener
let currentTask = null;
function startStream(taskId) {
  currentTask = taskId;
  const es = new EventSource('{{ url_for("processing.events", project_id=project.id) }}');
  es.onmessage = ev => {
    const msg = ev.data;
    const log = document.getElementById('log-window');
    log.textContent += msg + '\\n';
    // parse progress: assume “progress:XX” messages
    if (msg.startsWith('progress:')) {
      const pct = msg.split(':')[1];
      document.getElementById('bar').value = pct;
      document.getElementById('status').textContent = `Progress: ${pct}%`;
    }
    if (msg.trim().toLowerCase() === 'complete') {
      es.close();
      document.getElementById('status').textContent = 'Done!';
    }
  };
}
</script>
{% endblock %}
